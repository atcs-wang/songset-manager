<%# Must pass in:
- band { name, member : {role}}
- setlist: {name, date_pretty, date_yyyymmdd, descr, archived,
            songs: []
            }
- songlist: []
%>

<!DOCTYPE html>
<html lang="en">
<% var viewDirRoot = '../'; %>
<% var isCoreMember = (band.member.role=='owner' || band.member.role=='core' ); %>
<% var promptSongAddition = isCoreMember && !setlist.archived && (setlist.songs.length == 0); %>
<% var allowEdit = isCoreMember && !setlist.archived %>

<head>
    <%- include(viewDirRoot + 'partials/stdhead', {title: `${setlist.name} : ${band.name} `}) %>

    <link rel="stylesheet" href="/stylesheets/tagStyle.css">
    <link rel="stylesheet" href="/stylesheets/sortableStyle.css">
    <link rel="stylesheet" href="/stylesheets/listSortStyle.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script src="/scripts/ejs.min.js"></script>

</head>

<body>

    <%- include(viewDirRoot + 'partials/navbar', {breadcrumbs : 
        setlist.archived ? 
            [{href: `/band/${band.band_id}/`, text: band.name}, 
                {href: `/band/${band.band_id}/setlist/all`, text: "Setlists"},
                {href: `/band/${band.band_id}/setlist/archive`, text: "Archive"},
                {href:  `/band/${band.band_id}/setlist/${setlist.setlist_id}`, text: setlist.name }]
            :
            [{href: `/band/${band.band_id}/`, text: band.name}, 
                {href: `/band/${band.band_id}/setlist/all`, text: "Setlists"},
                {href:  `/band/${band.band_id}/setlist/${setlist.setlist_id}`, text: setlist.name }]
    }) %>

    <ul class="tabs tabs-fixed-width">
        <li class="tab col s6 m6"><a href="#setlist">View / Edit Setlist</a></li>
        <li class="tab col s6 m6 <% if (!allowEdit) { %> disabled <%}%>"><a href="#songlist">Add Songs</a></li>
    </ul>

    <!-- Actual page content! -->


    <form id="deleteSetlistForm" class="confirm-submit right" method="post" display="hidden"
        action="/band/<%=band.band_id%>/setlist/<%=setlist.setlist_id%>"
        data-confirm-msg='Confirm that you want to delete this setlist by retyping "<%=setlist.name%>":'
        data-require-retype="<%=setlist.name%>">
        <input type="hidden" name="method" value="delete">
        <% if (setlist.archived) { %>
        <input type="hidden" name="redirect" value="archive">
        <% } %>
    </form>

    <div class="container">
        
        <% if (isCoreMember) { %>

        <div class="modal" id="editsetlistdetails">


            <div class="modal-content">

                    <h4>Edit setlist details:</h4>

                                    
                    <div class="row">
                        <div class="input-field col s6">
                            <input type="text" id="nameInput" name="name" class="validate" data-length="45" required form="editSetlistForm"
                            value="<%=setlist.name%>">
                            <label for="nameInput">Name:</label>
                        </div>
                        <div class="input-field col s6">
                            <input type="date" id="dateInput" name="date" class="validate" form="editSetlistForm"
                            value="<%=setlist.date_yyyymmdd%>">
                            <label for="artistInput">Date:</label>
                        </div>
                    </div>
                
                    <div class="row">
                       <div class="input-field col s12">
                                    <textarea class="materialize-textarea" id="descrInput" name="descr" form="editSetlistForm"><%=setlist.descr%></textarea>
                                    <label for="descrInput">Description:</label>
                        </div>
                    </div>
                
            </div>

            <div class="modal-footer">
                <button class="btn waves-effect waves-light " type="submit" form="editSetlistForm">
                    <i class="material-icons right">save</i>
                    Save
                </button>
                <button class="modal-close waves-effect waves-green btn-flat" >Close</button>
            </div>

        </div>

        <% } %>

        <div id="setlist">
            <div class="section">
            <h4><%=setlist.name%>
                <% if (isCoreMember) { %>
                    <a class="btn-floating btn-small waves-effect waves-light orange modal-trigger tooltipped" 
                    data-tooltip="Edit Title / Date / Description" data-position="right"
                    href="#editsetlistdetails"><i class="material-icons">edit</i></a>
                    <span class="right">
                        <% if (setlist.archived) { %>
                            
                            <button class="confirm-submit btn-floating btn-large waves-effect waves-light green tooltipped" type="submit"
                                name="archive" value="unarchive" form="editSetlistForm"
                                data-confirm-msg='Confirm that you want to UN-archive the setlist "<%=setlist.name%>":'
                                data-tooltip="Unarchive" data-position="top">
                                <i class="material-icons right">unarchive</i>
                            </button>
                        
                            <% } else { %>
        
                            <button class="confirm-submit btn-floating btn-large waves-effect waves-light grey tooltipped" type="submit"
                                name="archive" value="archive" form="editSetlistForm"
                                data-confirm-msg='Confirm that you want to archive the setlist "<%=setlist.name%>":'
                                data-tooltip="Archive" data-position="top">
                                <i class="material-icons right">archive</i>
                            </button>
                        <% } %>
                        
                        
                            <button class="btn-floating btn-large waves-effect waves-light red tooltipped" type="submit"
                                form="deleteSetlistForm" data-tooltip="Delete" data-position="top">
                            <i class="material-icons right">delete</i>
                            </button>
                    </span>
                <% } %>
                
            </h4>
            <h5><%=setlist.date_pretty%></h5>
                    <h6><%=setlist.descr%></h6>
                    <label>Last updated: <%= setlist.updated_at_pretty%></label>
            <% if (setlist.archived && isCoreMember) { %>
                <blockquote>This setlist is archived, which means songs can't be added, removed, or changed until un-archived. 
                    <br>Click the green button above to un-archive.</blockquote>
            <% } %>
            </div>
            <form id="editSetlistForm" method="post" action="/band/<%=band.band_id%>/setlist/<%=setlist.setlist_id%>">  
                <input type="hidden" name="method" value="update">
                
                <ul  id="setlist-songs" class="collapsible expandable popout">
                        <li id="empty-message">
                            <blockquote>
                                This set doesn't have any songs. 
                                <% if (allowEdit) { %>                                
                                <br>    
                                Click the ADD SONGS Tab above to choose and add songs.
                                <br>
                                Afterwards, you can re-arrange the setlist and add notes to your songs.
                                <% } %>
                            </blockquote>
                        </li>
                    <% for (song of setlist.songs) { %>

                        <li>
                            <input type="hidden" form="editSetlistForm" name="song_id" value="<%= song.song_id %>">
                            
                            <div class="collapsible-header valign-wrapper">
                                <i class="material-icons handle tooltipped" 
                                    data-tooltip="Drag to rearrange" data-position="right">music_note</i>
                                <div class="tooltipped" data-tooltip="Click to expand details" data-position="top">
                                    <strong class="blue-text text-darken-3">
                                        <%= song.title %>
                                    </strong>
                                    <span><em><%=song.note%></em></span>
                                </div>
                                <span class="badge tooltipped" data-tooltip="Remove" data-position="top">
                                    <i class="material-icons red-text remove-song" data-title="<%= song.title %>">delete</i>
                                </span>
                                
                            </div>
                            <div class="collapsible-body">
                                
                                Title: <a href="/band/<%= band.band_id %>/song/<%= song.song_id %>" target="_blank"
                                    class="tooltipped" data-tooltip="Edit song details" data-position="top">
                                    <%= song.title %>
                                </a>
                                <br>
                                Artist: <strong><%= song.artist%></strong>
                                <br>
                                (Typical) Key: <strong><%=song.key%></strong> 
                                <br>
                                Tempo: <strong><%=song.tempo%></strong>
                                <br>
                                Tags: <div class="chips tags readonly no-autoinit">
                                    <% for (tag of song.tags.split(",")) {
                                        if (tag != '') {%>
                                            <div class="chip"><%=tag%></div>
                                    <%}}%>
                                </div>
                                <br>
                                Most Recent Set: <strong>
                                    <a href="/set/<%=song.recent_set_id %>"><%= song.recent_set_name %></a> - <span><%= song.last_played_pretty %></span> 
                                </strong>
                                <div class="input-field">
                                    <label>Add a Performance Note:</label>
                                    <input type="text" form="editSetlistForm" name="note" value="<%=song.note%>">
                                </div>

                            </div>
                            
                        </li>
                    <% } %>
                </ul>             
            </form>
        </div>      


        <% if (allowEdit) { %>
        
        <div id="songlist">
            <div class="row">
                <div class="input-field">
                <i class="material-icons prefix">search</i>
                <input id="searchBar" type="text" class="search">
                <label for="searchBar">Search by Title, Artist, Tags, Key, Tempo, or Recent Set</label>
                </div>
            </div>
            <div class="row">
                <button class="btn-flat sort waves-light waves-effect" data-sort="title">Sort by Title</button>
                <button class="btn-flat sort waves-light waves-effect" data-sort="artist">Sort by Artist</button>
                <button class="btn-flat sort waves-light waves-effect" data-sort="key">Sort by Key</button>
                <button class="btn-flat sort waves-light waves-effect" data-sort="tempo">Sort by Tempo</button>
                <button class="btn-flat sort waves-light waves-effect" data-sort="last-played">Sort by Last Played</button>
                <ul class="pagination paginationTop right"></ul>
            </div>
            <table>
                <thead>
                    <tr>
                        <th><span class="sort" data-sort="title">Title</span></th>
                        <th><span class="sort" data-sort="artist">Artist</span></th>
                        <th>Tags</th>
                        <th><span class="sort" data-sort="key">Key</span></th>
                        <th><span class="sort" data-sort="tempo">Tempo</span></th>
                        <th><span class="sort" data-sort="last-played">Most Recent Set</span></th>
                        <th></th>
                    </tr>
            
                </thead>
                <tbody class="list">
                    <% for (song of songlist) { %>
                    <tr data-song-id="<%= song.song_id %>">
                        <td> 
                            <a href="/band/<%= band.band_id %>/song/<%= song.song_id %>" target="_blank"
                                class="title tooltipped" data-tooltip="Edit song details" data-position="top"
                            ><%= song.title %></a>
                        </td>
                        <td class="artist"><%= song.artist %></td>
                        <td class="tags" data-tags="<%=song.tags%>" >
                            <div class="chips tags readonly no-autoinit">
                                <% for (tag of song.tags.split(",")) {
                                    if (tag != '') {%>
                                        <div class="chip"><%=tag%></div>
                                <%}}%>
                            </div>
                        </td>
                        <td class="key"><%= song.key%></td>
                        <td class="tempo"><%= song.tempo %></td>
                        <td class="last-played-yyyymmdd recent-set-id" data-last-played-yyyymmdd="<%= song.last_played_yyyymmdd %>" data-recent-set="<%= song.recent_set_id %>">
                            <a href="/set/<%= song.set_id %>" class="recent-set-name"><%= song.recent_set_name %></a> - 
                            <span class="last-played-pretty"><%= song.last_played_pretty %></span>
                        </td>
                        <td>
                            <button class="btn btn-floating waves-effect waves-light add-song tooltipped" data-song-id="<%= song.song_id %>"
                                data-tooltip="Add Song To Setlist" data-position="top">
                            <i class="material-icons right">add</i>
                            </button>
                        </td>
                    </tr>
                    <% } %>
                </tbody>
            </table>
            <ul class="pagination paginationBottom right"></ul>

        </div>

        <% } %>

        <% if (allowEdit) { %>
                <div class="fixed-action-btn">

                    <button class="btn-floating btn-large waves-effect waves-light pulse tooltipped" type="submit" 
                        form="editSetlistForm"  data-tooltip="Save Changes" data-position="left">
                        <i class="material-icons right">save</i>
                    </button>
                </div>

        <% } %>


    </div>
    

    <%- include('../partials/stdfoot') %>
    <script src="/scripts/songListInit.js"></script>
    <script src="/scripts/collapsibleInit.js"></script>
    <% if (allowEdit) {%>
        <script src="/scripts/setlistSongSortableAddDelete.js"></script>
    <% } %>

</body>

</html>