<%# Must pass in:
- band { name, member : {role}}
- setlist: {name, date_pretty, date_yyyymmdd, descr, archived,
            songs: []
            }
- songlist: []
%>

<!DOCTYPE html>
<html lang="en">
<% var viewDirRoot = '../'; %>
<% var isCoreMember = (band.member.role=='owner' || band.member.role=='core' ); %>
<% var promptSongAddition = isCoreMember && !setlist.archived && (setlist.songs.length == 0); %>
<% var allowEdit = isCoreMember && !setlist.archived %>

<head>
    <%- include(viewDirRoot + 'partials/stdhead', {title: `${setlist.name} : ${band.name} `}) %>

    <link rel="stylesheet" href="/stylesheets/tagStyle.css">
    <link rel="stylesheet" href="/stylesheets/sortableStyle.css">
    <link rel="stylesheet" href="/stylesheets/listSortStyle.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/list.js/2.3.1/list.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script src="/scripts/ejs.min.js"></script>

</head>

<body>

    <%- include(viewDirRoot + 'partials/navbar', {breadcrumbs : 
        setlist.archived ? 
            [{href: `/band/${band.band_id}/`, text: band.name}, 
                {href: `/band/${band.band_id}/setlist/all`, text: "Setlists"},
                {href: `/band/${band.band_id}/setlist/archive`, text: "Archive"},
                {href:  `/band/${band.band_id}/setlist/${setlist.setlist_id}`, text: setlist.name }]
            :
            [{href: `/band/${band.band_id}/`, text: band.name}, 
                {href: `/band/${band.band_id}/setlist/all`, text: "Setlists"},
                {href:  `/band/${band.band_id}/setlist/${setlist.setlist_id}`, text: setlist.name }]
    }) %>



    <div>
        <ul class="tabs row">
            <li class="tab col s6 "><a href="#setlist">View / Edit Setlist</a></li>
            <li class="tab col s6 <% if (!allowEdit) { %> disabled <%}%>"><a href="#songlist">Add Songs</a></li>
        </ul>
    </div>

    <!-- Actual page content! -->

    <div class="container">
        
        <% if (allowEdit) { %>

        <div class="modal" id="editsetlistdetails">

            <div class="modal-content">

                    <h2>Edit Setlist details:</h2>
                                    
                    <div class="row">
                        <div class="input-field col s6">
                            <input type="text" id="nameInput" name="name" class="validate" data-length="45" required form="editSetlistForm"
                            value="<%=setlist.name%>">
                            <label for="nameInput">Name:</label>
                        </div>
                        <div class="input-field col s6">
                            <input type="date" id="dateInput" name="date" class="validate" form="editSetlistForm"
                            value="<%=setlist.date_yyyymmdd%>">
                            <label for="artistInput">Date:</label>
                        </div>
                    </div>
                
                    <div class="row">
                       <div class="input-field col s12">
                                    <textarea class="materialize-textarea" id="descrInput" name="descr" form="editSetlistForm"><%=setlist.descr%></textarea>
                                    <label for="descrInput">Description:</label>
                        </div>
                    </div>
                
            </div>

            <div class="modal-footer">
                <button class="btn waves-effect waves-light " type="submit" form="editSetlistForm">
                    <i class="material-icons right">send</i>
                    Update Setlist details
                </button>
                <button class="modal-close waves-effect waves-green btn-flat" >Never Mind</button>
            </div>

        </div>

        <% } %>

        <div id="setlist">
            <div class="section">
            <h4><%=setlist.name%>
                <% if (allowEdit) { %>
                    <a class="btn-floating btn-small waves-effect waves-light orange modal-trigger " 
                    href="#editsetlistdetails"><i class="material-icons">edit</i></a>
                <% } %>
                <span class="right  right-align ">
                <% if (setlist.archived) { %>
                    <form method="post" display="inline"  method="post" 
                        action="/band/<%=band.band_id%>/setlist/<%=setlist.setlist_id%>"
                    >
    
                        <input type="hidden" name="method" value="unarchive">
    
                        <button class="btn-small waves-effect waves-light green" type="submit">
                            <i class="material-icons right">unarchive</i>
                            Unarchive
                        </button>
                    </form>
    
                    <% } else { %>
    
                        <form method="post" display="inline"  method="post" 
                        action="/band/<%=band.band_id%>/setlist/<%=setlist.setlist_id%>"
                    >
    
                        <input type="hidden" name="method" value="archive">
    
                        <button class="btn-small waves-effect waves-light grey" type="submit">
                            <i class="material-icons right">archive</i>
                            Archive
                        </button>
                    </form>
                <% } %>
                    <form class="confirm-submit" method="post" display="inline"
                        action="/band/<%=band.band_id%>/setlist/<%=setlist.setlist_id%>"
                        data-confirm-msg='Confirm that you want to delete this setlist by retyping "<%=setlist.name%>":'
                        data-require-retype="<%=setlist.name%>">
    
                        <input type="hidden" name="method" value="delete">
    
                        <button class="btn waves-effect waves-light red" type="submit">
                            <i class="material-icons right">delete</i>
                            Delete
                        </button>
                    </form>
                    <% if (allowEdit) { %>
                        <div class="section">

                            <button class="btn-large waves-effect waves-light" type="submit" form="editSetlistForm"
                                action="/band/<%=band.band_id%>/setlist/<%=setlist.setlist_id%>"
                            >
                                <i class="material-icons right">save</i>
                                Save Changes
                            </button>
                        </div>

                <% } %>
                </span>
            </h4>
            <h5><%=setlist.date_pretty%></h5>
                    <h6><%=setlist.descr%></h6>
                    <label>Last updated: <%= setlist.updated_at_pretty%></label>
           
            </div>
            <form id="editSetlistForm" method="post">  
                <input type="hidden" name="method" value="update">
                
        
                <ul  id="setlist-songs" class="collapsible expandable popout tooltipped" 
                data-position="top" data-tooltip="Click to expand details. Drag the music notes to rearrange.">
                        <li id="empty-message">
                            <blockquote>
                                This set doesn't have any songs. 
                                <% if (allowEdit) { %>                                
                                <br>    
                                Click the ADD SONGS Tab above to choose and add songs.
                                <br>
                                Afterwards, you can re-arrange the setlist and add notes to your songs.
                                <% } %>
                            </blockquote>
                        </li>
                    <% for (song of setlist.songs) { %>

                        <li>
                            <input type="hidden" form="editSetlistForm" name="song_id" value="<%= song.song_id %>">
                            
                            <div class="collapsible-header valign-wrapper">
                                <i class="material-icons handle">music_note</i>
                                <div>
                                    <a href="/band/<%= band.band_id %>/song/<%= song.song_id %>" target="_blank">
                                        <%= song.title %>
                                    </a>
                                    <span><em><%=song.note%></em></span>
                                </div>
                                <span class="badge"><i class="material-icons red-text remove-song" data-title="<%= song.title %>">delete</i>
                                </span>
                                
                            </div>
                            <div class="collapsible-body">
                                <div class="input-field">
                                    <label>Performance Notes:</label>
                                    <input type="text" form="editSetlistForm" name="note" value="<%=song.note%>">
                                </div>
                            
                                <br>
                                Artist: <strong><%= song.artist%></strong>
                                <br>
                                Tags: <div class="chips tags readonly no-autoinit">
                                    <% for (tag of song.tags.split(",")) {
                                        if (tag != '') {%>
                                            <div class="chip"><%=tag%></div>
                                    <%}}%>
                                </div>
                                <br>
                                (Typical) Key: <strong><%=song.key%></strong> 
                                <br>
                                Tempo: <strong><%=song.tempo%></strong>
                                <br>
                                Most Recent Set: <strong><a href="/set/<%=song.recent_set_id %>"><%= song.recent_set_name %></a> - <span><%= song.last_played_pretty %></span> </strong>
                            
                            </div>
                            
                        </li>
                    <% } %>
                </ul>
                <ul id="setlist-songs-trash" >
                    <li>
                        <div class="fixed-action-btn" >
                        <a class="btn-floating btn-large red">
                            <i class="large material-icons handle">delete</i>
                        </a>
                        </div>
                    </li>
                </ul>
                                                
            </form>
        </div>      


        <% if (allowEdit) { %>
        
        <div id="songlist">
            <div class="row">
                <div class="input-field">
                <i class="material-icons prefix">search</i>
                <input id="searchBar" type="text" class="search">
                <label for="searchBar">Search by Title, Artist, Tags, Key, Tempo, or Recent Set</label>
                </div>
            </div>
            <div class="row">
                <button class="btn-flat sort waves-light waves-effect" data-sort="title">Sort by Title</button>
                <button class="btn-flat sort waves-light waves-effect" data-sort="artist">Sort by Artist</button>
                <button class="btn-flat sort waves-light waves-effect" data-sort="key">Sort by Key</button>
                <button class="btn-flat sort waves-light waves-effect" data-sort="tempo">Sort by Tempo</button>
                <button class="btn-flat sort waves-light waves-effect" data-sort="last-played">Sort by Last Played</button>
                <ul class="pagination paginationTop right"></ul>
            </div>
            <table>
                <thead>
                    <tr>
                        <th><span class="sort" data-sort="title">Title</span></th>
                        <th><span class="sort" data-sort="artist">Artist</span></th>
                        <th>Tags</th>
                        <th><span class="sort" data-sort="key">Key</span></th>
                        <th><span class="sort" data-sort="tempo">Tempo</span></th>
                        <th><span class="sort" data-sort="last-played">Most Recent Set</span></th>
                        <th></th>
                    </tr>
            
                </thead>
                <tbody class="list">
                    <% for (song of songlist) { %>
                    <tr data-song-id="<%= song.song_id %>">
                        <td> 
                            <a href="/band/<%= band.band_id %>/song/<%= song.song_id %>" class="title"><%= song.title %></a>
                        </td>
                        <td class="artist"><%= song.artist %></td>
                        <td class="tags" data-tags="<%=song.tags%>" >
                            <div class="chips tags readonly no-autoinit">
                                <% for (tag of song.tags.split(",")) {
                                    if (tag != '') {%>
                                        <div class="chip"><%=tag%></div>
                                <%}}%>
                            </div>
                        </td>
                        <td class="key"><%= song.key%></td>
                        <td class="tempo"><%= song.tempo %></td>
                        <td class="last-played-yyyymmdd recent-set-id" data-last-played-yyyymmdd="<%= song.last_played_yyyymmdd %>" data-recent-set="<%= song.recent_set_id %>">
                            <a href="/set/<%= song.set_id %>" class="recent-set-name"><%= song.recent_set_name %></a> - 
                            <span class="last-played-pretty"><%= song.last_played_pretty %></span>
                        </td>
                        <td>
                            <button class="btn waves-effect waves-light add-song" data-song-id="<%= song.song_id %>">
                            <i class="material-icons right">send</i> Add Song To Setlist
                            </button>
                        </td>
                    </tr>
                    <% } %>
                </tbody>
            </table>
            <ul class="pagination paginationBottom right"></ul>

        </div>

        <% } %>



    </div>

    <%- include('../partials/stdfoot') %>
    <script src="/scripts/songListInit.js"></script>
    <script src="/scripts/collapsibleInit.js"></script>
    <script src="/scripts/setlist.js"></script>
    <script src="/scripts/setlistSongSortableAddDelete.js"></script>


</body>

</html>